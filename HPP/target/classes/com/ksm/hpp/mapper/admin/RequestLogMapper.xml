<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mapper.admin.RequestLogMapper">
	
	<!-- 사용자 접속 기록 조회-->
	<select id="selectRequestLog" parameterType="map" resultType="camelCaseMap">
		SELECT T1.REQ_SEQ					/*요청일련번호*/
		     , DATE_FORMAT(T1.REQ_DTTI, '%Y/%m/%d %H:%i:%s') AS REQ_DTTI 				/*요청일시*/
		     , T1.USER_ID					/*사용자아이디*/
		     , T1.USER_IP					/*사용자아이피*/
		     , T1.REQ_URI					/*요청경로*/
		     , IF(LENGTH(T1.REQ_PARAM)  <![CDATA[>]]>  100, CONCAT(SUBSTR(T1.REQ_PARAM, 1, 100),'...'), T1.REQ_PARAM) REQ_PARAM		/*요청파라미터*/
		     , T1.REQ_TYPE_CODE				/*요청타입코드*/
		     , IFNULL(T2.CODE_DETAIL_NM, '기타') REQ_TYPE_NM	/*요청타입명*/	     
		  FROM TB_LOG_REQ T1				/*테이블_요청로그*/
		  LEFT OUTER JOIN TB_CODE_DETAIL T2	/*테이블_코드상세*/
		    ON T1.REQ_TYPE_CODE = T2.CODE_DETAIL	
		 WHERE REQ_DTTI BETWEEN DATE_FORMAT(#{reqDttiStr}, '%Y-%m-%d %H:%i') AND DATE_FORMAT(#{reqDttiEnd}, '%Y-%m-%d %H:%i')
		   AND T1.REQ_TYPE_CODE IN(
		     <foreach collection="reqTypeCode" item="code" index="index" separator=",">
		        #{code}
		     </foreach>	
	     	   )
		<if test='userId != null and userId != ""'>
		   AND T1.USER_ID LIKE CONCAT('%',#{userId},'%')
		</if>
		<if test='userIp != null and userIp != ""'>
		   AND T1.USER_IP LIKE CONCAT('%',#{userIp},'%')
		</if>		
		<if test='reqUri != null and reqUri != ""'>
		   AND T1.REQ_URI LIKE CONCAT('%',#{reqUri},'%')
		</if>
		<if test='reqParam != null and reqParam != ""'>
		   AND T1.REQ_PARAM LIKE CONCAT('%',#{reqParam},'%')
		</if>	
		 ORDER BY REQ_DTTI DESC
		<if test='strIdx != null and strIdx != ""'>
		 LIMIT ${strIdx}, ${pageLength}
		</if>		
	</select>
	
	<!-- 사용자 접속 기록 개수-->
	<select id="selectRequestLogCnt" parameterType="map" resultType="int">
		SELECT COUNT(*)
		  FROM TB_LOG_REQ T1				/*테이블_요청로그*/
		<trim prefix="WHERE" prefixOverrides="AND">  
			<if test='userId != null and userId != ""'>
		   AND USER_ID = #{userId}
			</if>
		</trim>
	</select>	
</mapper>